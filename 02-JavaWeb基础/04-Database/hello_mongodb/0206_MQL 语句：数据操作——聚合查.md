## 聚合查 aggregate

MongoDB 的聚合查跟 MySQL 的聚合查不是一个概念，MongoDB 的聚合查能做很多操作，MySQL 聚合查只是 MongoDB 聚合查的一小部分功能。MongoDB 的聚合查会按聚合操作步骤依次把数据进行“流水线处理”，最终查询出我们想要的数据。

**聚合查的格式如下：**

```javascript
db.product.aggregate([
	{ 聚合操作 1 },
	{ 聚合操作 2 },
	{ 聚合操作 3 },
	...
]);
```

## 1、聚合操作 $match —— 条件查询的查询条件

类似于前面基本查里条件查询的第一个 map 参数，作用类似于 SQL 语句里的 WHERE，用来写查询条件，只不过聚合查里不能用前面的基本查，只能用 $match 来写查询条件

```javascript
// 这就是在查询部分数据的所有字段
// 价格 >= 4444 && 价格 <= 8888 的数据、所有字段
db.product.aggregate([
	{
		$match: {
			"price": {
				$gte: 4444,
				$lte: 8888
			}
		}
	}
]);
```

## 2、聚合操作 $project —— 条件查询的要查询哪些字段

类似于前面基本查里条件查询的第二个 map 参数，用来一一列出要查询哪些字段，只不过聚合查里不能用前面的基本查，只能用 $project 来一一列出要查询哪些字段

```javascript
// 这就是在查询所有数据的部分字段
// 所有数据、name 和 price 字段
db.product.aggregate([
	{
		$project: {
			"productName": "$name", // 把 name 字段重命名为 productName，这样它的值默认就是 1，避免命名冲突
			"price": 1
		}
	}
]);
```

## 3、聚合操作 $group —— 分组

类似于 MySQL 里的 GROUP BY，用来把所有的数据按照某个字段分成若干组

```javascript
db.product.aggregate([
	{
		$group: {
		  // _id 这个 key 是固定的，value 是数据库里的某个字段
			// 代表按这个字段进行分组，这个字段的值相同的数据会被分到同一组
			_id: "$brand",
			// maxPrice 这对 key-value 是自定义的，我们想获取分组后每组的最高价格
			maxPrice: { $max: "$price" },
			// minPrice 这对 key-value 是自定义的，我们想获取分组后每组的最低价格
      minPrice: { $min: "$price" },
			// avgPrice 这对 key-value 是自定义的，我们想获取分组后每组的平均价格
      avgPrice: { $avg: "$price" },
			// count 这对 key-value 是自定义的，我们想获取分组后每组的数据条数（$sum: 1 代表分组里每进来一条数据就加 1）
			count: { $sum: 1 }
		}
	}
]);
```

## 4、聚合操作 $sort —— 对查询结果进行排序

类似于前面基本查里的对查询结果进行排序，只不过聚合查里不能用前面的基本查，只能用 $sort 来对查询结果进行排序

```javascript
// 按价格升序排序
db.product.aggregate([
	{
		$sort: {
			"price": 1 // 1 升序、-1 降序
		}
	}
]);
```

## 5、聚合操作 $limit + $skip —— 分页查询

类似于前面基本查里的分页查询，只不过聚合查里不能用前面的基本查，只能用 $limit + $skip 来分页查询

```javascript
// 假设一页 3 条数据，这就是查询第 1 页数据
// $skip：跳过多少条 = (pageNum - 1) * pageSize
// limit：返回多少条 = pageSize
db.product.aggregate([
	{ $skip: 0 },
	{ $limit: 3 }
]);
```

## 多聚合操作组合

```javascript
db.product.aggregate([
  // 聚合操作 1：先查询出 价格 >= 4444 && 价格 <= 8888 的数据、所有字段
	{
		$match: {
			"price": {
				$gte: 4444,
				$lte: 8888
			}
		}
	},
  // 聚合操作 2：在聚合操作 1 查出数据的基础上只保留 name、price、brand 字段
	{
		$project: {
			"name": 1,
			"price": 1,
			"brand": 1
		}
	},
  // 聚合操作 3：在聚合操作 2 查出数据的基础上按 brand 进行分组
	{
		$group: {
			_id: "$brand",
			maxPrice: { $max: "$price" },
      minPrice: { $min: "$price" },
      avgPrice: { $avg: "$price" },
			count: { $sum: 1 }
		}
	},
  // 聚合操作 4：在聚合操作 3 查出数据的基础上按 avgPrice 降序排序
	{
		$sort: { avgPrice: -1 }
	},
  // 聚合操作 5：在聚合操作 4 查出数据的基础上一页 2 条数据、查询第 1 页
	{
		$skip: 0
	},
	{
		$limit: 2
	}
]);
```

