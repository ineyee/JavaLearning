## 一、MyBatis 是什么

之前的 dao 数据层，我们是通过 JDK 提供的 JDBC API 来操作数据库的，但是 JDBC API 存在以下问题：

* 繁琐的资源创建和释放代码
* 繁琐的异常处理代码
* 繁琐的数据库表转 Java Bean 代码
* ......

MyBatis 是位于 dao 数据层的框架，它是对 JDBC API 的封装，可以大大简化我们的开发代码，所以我们接下来会用 MyBatis 来操作数据库。

## 二、怎么使用 MyBatis

#### 1、添加依赖

首先安装 MyBatis：

```XML
<dependency>
    <groupId>org.mybatis</groupId>
    <artifactId>mybatis</artifactId>
    <version>3.5.19</version>
</dependency>
```

然后我们知道 MyBatis 对应的是之前的 JDBC API，所以我们还需要安装数据库驱动、连接池：

```XML
<dependency>
    <groupId>com.mysql</groupId>
    <artifactId>mysql-connector-j</artifactId>
    <version>9.4.0</version>
</dependency>
<dependency>
  <groupId>com.alibaba</groupId>
  <artifactId>druid</artifactId>
  <version>1.2.27</version>
</dependency>
```

但是因为 MyBatis 内部自带了连接池，所以要想让 MyBatis 使用三方连接池，还得做一些事情：

* 在 java 目录下创建一个名字叫做 common 的文件夹，在 common 目录下创建一个名字叫做 DruidDataSourceFactory 的类

```Java
package common;

import com.alibaba.druid.pool.DruidDataSource;
import org.apache.ibatis.datasource.pooled.PooledDataSourceFactory;

// 必须继承自 PooledDataSourceFactory
public class DruidDataSourceFactory extends PooledDataSourceFactory {
    public DruidDataSourceFactory() {
        // 必须把 DruidDataSource 设置给 dataSource 属性
        this.dataSource = new DruidDataSource();
    }
}
```

* 去 mybatis-config.xml 配置文件（下面会说到）里配置一下连接池

```XML
<environment id="dev">
    <transactionManager type="JDBC"/>
    <dataSource type="common.DruidDataSourceFactory">
        <property name="driverClassName" value="com.mysql.cj.jdbc.Driver"/>
        <property name="url" value="jdbc:mysql://localhost:3306/db_hello_mysql?serverTimezone=UTC"/>
        <property name="username" value="root"/>
        <property name="password" value="mysqlroot"/>
        <property name="initialSize" value="5"/>
        <property name="maxActive" value="10"/>
    </dataSource>
</environment>
```

我们还可以安装一个分页查询库：

* 因为不同的数据库如 MySQL、Oracle、PostgreSQL 等有不同的分页查询语句，这样我们在数据层就得写不同的 SQL 语句，但是有了分页查询库，我们在数据层就可以写一份 SQL 语句来自适应不同的数据库

```XML
<dependency>
    <groupId>com.github.pagehelper</groupId>
    <artifactId>pagehelper</artifactId>
    <version>6.1.1</version>
</dependency>
```

* 然后去 mybatis-config.xml 配置文件（下面会说到）里配置一下分页查询库

```XML
<!-- 插件 -->
<plugins>
    <!-- 拦截器设置为 PageHelper 的 PageInterceptor -->
    <plugin interceptor="com.github.pagehelper.PageInterceptor">
        <!--
            reasonable 设置为 true，代表使分页查询合理化：
                当 pageNum <= 0 时，自动返回第一页的数据
                当 pageNum > totalPage 时，自动返回最后一页的数据
        -->
        <property name="reasonable" value="true"/>
    </plugin>
</plugins>
```

* 使用 PageHelper 实现分页查询的话，SQL 语句里就不用再写 LIMIT OFFSET 了，PageHelper 会自动帮我们拼接上去，但是注意 SQL 语句的结尾不能写分号，否则 PageHelper 帮我们自动拼接的部分就不生效了

```XML
<select id="listPageHelper" parameterType="Map" resultType="UserBean">
    SELECT id,
           name,
           age,
           height,
           email,
           create_time,
           update_time
    FROM t_user
    ORDER BY create_time DESC
</select>
```

* 然后在 Java 代码分页查询的地方调用一下 PageHelper.startPage(pageNum, pageSize) 方法就可以了

```JAVA
// 查询成功一般是给客户端返回 data=[bean]，查询失败一般是给客户端返回 data=[]
@Test
void listPageHelper() {
    // 创建一个会话，项目运行期间可以创建多个
    try (SqlSession session = MyBatisUtil.openSession()) {
        // 执行 SQL 语句
        // session.selectList(statement, parameter)：用来查询多条数据，查到则返回 [bean]，查不到则返回 []
        //   statement（String）：SQL 语句的命名空间.SQL 语句的唯一标识
        //   parameter（Object）：SQL 语句的参数，没有参数的话就不用传
        Integer pageNum = 1; // 当前页码，从 1 开始
        Integer pageSize = 2; // 每页显示多少条数据
        PageHelper.startPage(pageNum, pageSize);
        List<UserBean> userBeanList = session.selectList("dao.UserDao.listPageHelper");
        if (!userBeanList.isEmpty()) {
            System.out.println("查询成功：" + userBeanList);
        } else {
            System.out.println("查询失败");
        }
    }
}
```

我们还可以安装一个日志打印库，以便更好地查看 MyBatis 的执行日志：

```XML
<dependency>
    <groupId>ch.qos.logback</groupId>
    <artifactId>logback-classic</artifactId>
    <version>1.5.19</version>
    <scope>compile</scope>
</dependency>
```

#### 2、创建 MyBatis 的配置文件

在 resources 目录下创建一个名字叫做 mybatis-config.xml 的配置文件，专门用来配置 MyBatis 相关的东西，详见配置文件里。

```XML
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE configuration
        PUBLIC "-//mybatis.org//DTD Config 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-config.dtd">
<!--
    configuration 标签里的内容必须按下面的顺序编写：
        1、properties (可选)
        2、settings (可选)
        3、typeAliases (可选)
        4、typeHandlers (可选)
        5、objectFactory (可选)
        6、objectWrapperFactory (可选)
        7、reflectorFactory (可选)
        8、plugins (可选)
        9、environments (可选)
        10、databaseIdProvider (可选)
        11、mappers (可选)
-->
<configuration>
</configuration>
```

#### 3、创建数据库表自动转 Java Bean 的映射文件

在 resources 目录下创建一个名字叫做 mappers 的文件夹，该目录下的一个映射文件对应一张表和一个 Java Bean

在 mappers 目录下创建一个名字叫做 user.xml 的映射文件，顾名思义，这个映射文件专门用来配置数据库里 t_user 表和 Java 代码里 UserBean 的映射关系，详见映射文件里。`一定要在 mybatis-config.xml 配置文件里注册一下这个映射文件，否则 MyBatis 无法找到这个映射文件，也就无法完成数据库表自动转 Java Bean`

```XML
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.UserDao">
</mapper>
```

在 mappers 目录下创建一个名字叫做 product.xml 的映射文件，顾名思义，这个映射文件专门用来配置数据库里 t_product 表和 Java 代码里 ProductBean 的映射关系，详见映射文件里。`一定要在 mybatis-config.xml 配置文件里注册一下这个映射文件，否则 MyBatis 无法找到这个映射文件，也就无法完成数据库表自动转 Java Bean`

```XML
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="dao.ProductDao">
</mapper>
```

#### 4、编写 Java 代码去访问数据库

详见 UserTest、ProductTest 文件里。
